<html>
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
    <link rel="stylesheet" href="http://www.w3schools.com/lib/w3.css">
    <style type="text/css">
    .container {
        text-align: left;
        height: auto;
        width: 700px;
        clear: both;
    }
    .container input {
        text-align: left;
        width: 95%;
        clear: both;
    }
    /*.button {
    display: inline-block;
    padding: 10px 15px;
    font-size: 15px;
    cursor: pointer;
    text-align: center;
    text-decoration: none;
    outline: none;
    color: #fff;
    background-color: red;
    border: none;
    border-radius: 15px;
    box-shadow: 0 9px #999;
}
.button:hover
{
background-color: #3e8e41
}

.button:active {
background-color: #3e8e41;
box-shadow: 0 5px #666;
transform: translateY(4px);
}*/


}
</style>
</head>

<body>

    <div ng-app="myValidationApp" class="container" ng-controller="formCtrl">
        <h1>Cast Your Vote</h1>
        <hr>
        <p>First and last name must be alphabetical</p>
        <p>Social security number must be 9 digits long, no dashes necessary</p>
        <p>If given, phone number must be 10 digits long, no dashes necessary</p>
        <p><b>In order to vote, you must be at least 18 years of age</b></p>
        <hr>
        <p><span style="color:red">* indicates a required field</span></p>
        <form name="myForm" ng-submit="submitForm(myForm.$valid)" novalidate>
            First Name
            <input type="text" name="fname" ng-model="user.firstName" ng-pattern="/^[a-zA-Z]*$/" ng-class="{ 'has-error' : myForm.fname.$invalid && !myForm.fname.$pristine && submitted}" required>
            <span style="color:red"> *</span>
            <span style="color:red" ng-show="submitted && myForm.fname.$invalid">
                <span ng-show="myForm.fname.$error.required">First name is required.<br></span>
            </span>
            <span style="color:red" ng-show="myForm.fname.$invalid">
                <span ng-show="myForm.fname.$error.pattern">Only alphabetical characters allowed<br></span>
            </span>

            <br><br>Last Name
            <input type="text" name="lname" ng-model="user.lastName" ng-pattern="/^[a-zA-Z]*$/" ng-class="{ 'has-error' : myForm.lname.$invalid && !myForm.lname.$pristine && submitted} "required>
            <span style="color:red"> *</span>
            <span style="color:red" ng-show="submitted && myForm.lname.$invalid">
                <span ng-show="myForm.lname.$error.required">Last name is required.<br></span>
            </span>
            <span style="color:red" ng-show="myForm.lname.$invalid">
                <span ng-show="myForm.lname.$error.pattern">Only alphabetical characters allowed<br></span>
            </span>

            <br><br>Social Security Number
            <input type="text" name="ssn" ng-model="user.ssn" ng-pattern="/^(\d)+$/" ng-minlength="9" ng-maxlength="9" ng-class="{ 'has-error' : myForm.ssn.$invalid && !myForm.ssn.$pristine && submitted}" required>
            <span style="color:red"> *</span>
            <span style="color:grey" ng-show="myForm.ssn.$error.minlength || myForm.ssn.$error.maxlength">Social Security number must be 9 digits long</span>
            <span style="color:red" ng-show="submitted && myForm.ssn.$invalid">
                <span ng-show="myForm.ssn.$error.required">Social Security number is required.<br></span>
            </span>
            <span style="color:red" ng-show="myForm.ssn.$invalid">
                <span ng-show="myForm.ssn.$error.pattern">Digits only<br></span>
            </span>

            <br><br>Phone Number
            <input type="tel" name="phone" ng-model="user.phone" ng-pattern="/^(\d)+$/" ng-minlength="10" ng-maxlength="10">
            <span style="color:grey" ng-show="myForm.phone.$error.minlength || myForm.phone.$error.maxlength">Phone number must be 10 digits long</span>
            <span style="color:red" ng-show="myForm.phone.$invalid">
                <span ng-show="myForm.phone.$error.pattern">Digits only<br></span>
            </span>

            <br><br>Email
            <input type="email" name="email" ng-model="user.email" ng-class="{ 'has-error' : myForm.email.$invalid && !myForm.email.$pristine && submitted}" required>
            <span style="color:red"> *</span>
            <span style="color:red" ng-show="submitted && myForm.email.$invalid">
                <span ng-show="myForm.email.$error.required">Email is required.<br></span>
                <span ng-show="myForm.email.$error.email">Invalid email address.<br></span>
            </span>

            <br><br>DOB
            <input type="date" name="DOB" max="{{minAge | date:'yyyy-MM-dd'}}" ng-model="user.DOB" ng-class="{ 'has-error' : myForm.DOB.$invalid && !myForm.DOB.$pristine && submitted}" required>
            <span style="color:red"> *</span>
            <span style="color:red" ng-show="submitted && myForm.DOB.$invalid">
                <span ng-show="myForm.DOB.$error.required">Date of birth is required.<br></span>
            </span>
            <span style="color:red" ng-show="submitted && myForm.DOB.$error.max">Must be at least 18 years of age<br></span>

            <br><br>Choose a candidate<br>
            <select name="candidate" ng-model="mySelect" ng-class="{ 'has-error' : myForm.candidate.$invalid && !myForm.candidate.$pristine && submitted}" required>
                <option value="">--Select--
                    <option ng-repeat="c in candidates" value="{{c.id}}">{{c.name}}</option>
                </select>
                <span style="color:red"> *</span>

                <span style="color:red" ng-show="submitted && myForm.candidate.$invalid">
                    <span ng-show="myForm.candidate.$error.required"><br>{{msg}}You must select a candidate<br></span>
                </span>
                <div ng-switch="mySelect">
                    <div ng-switch-when="clinton">
                        <h1>Hillary Clinton </h1>
                        <p> Democrat </p>
                        <img src="clinton.jpg" height="200px" width="200px">
                    </div>
                    <div ng-switch-when="trump">
                        <h1>Donald Trump </h1>
                        <p> Republican </p>
                        <img src="trump.jpg" height="200px" width="200px">
                    </div>
                    <div ng-switch-when="johnson">
                        <h1>Gary Johnson</h1>
                        <p> Libritarian </p>
                        <img src="johnson.png" height="200px" width="200px">
                    </div>
                    <div ng-switch-when="stein">
                        <h1>Jill Stein</h1>
                        <p> Green </p>
                        <img src="stein.jpg" height="200px" width="200px">
                    </div>
                </div>
            </div>


            <button class="button" type="submit" ng-disable="hasUserVoted(user.ssn)">VOTE</button>
            <br>
        </form>
        <!-- <p>form = {{user}}</p>
        <p>master = {{master}}</p> -->

    </div>

    <script>
    var app = angular.module('myValidationApp', []);

    app.controller('formCtrl', function($scope, votes) {

        var votesService = votes;

        //check minimum age for DOB in form
        var today = new Date();
        var minAge = 18;
        $scope.minAge = new Date(today.getFullYear() - minAge, today.getMonth(), today.getDate());
        //object representing candidates
        $scope.candidates = [{"id": "clinton", "name": "Hillary Clinton", "votes": 0}, {"id": "trump", "name": "Donald Trump", "votes": 0},
        {"id": "johnson", "name": "Gary Johnson", "votes": 0}, {"id": "stein", "name": "Jill Stein", "votes": 0}];
        //TODO implement a user object and check for ability to vote

        $scope.hasUserVoted = function(userSSN)
        {
            if(user.ssn.hasVoted)
            {
                return false; //already voted
            }
            else return true; //can vote
        }

        $scope.submitForm = function(isValid)
        {
            $scope.submitted = true;
            if(isValid)
            {
                votesService.vote($scope.mySelect);
            }
            else
            {
                alert("Form not valid. Please fix the required fields");
            }
        }
        votesService.vote = function(candidate)
        {
            votes.add(candidate);

            $scope.getData = function(){
                votesService.add(candidate).then(function(data){
                    $scope.getData = data;
                    console.log("in controller dta is ");
                    console.log(data);
                });
            };
        }
    });
    //custom service to handle voting - retrieving from and sending to the server
    app.factory('votes', function($http)
    {
        var votesObj = {};
        //get current votes from server

        $http.get("getVotes.php").success(function(data)
        {
            console.log("From getVotes.php:");
            votesObj = data;
            console.log(votesObj);

        })
        votesObj.add = function(candidate)
        {

            $http.post("sendVotes.php", {'candidate': candidate, 'votes': votesObj}).then(function(response)
            {
                alert("Thank you for voting!");
                console.log("after sendVotes.php:");
                console.log(response.data);
                return response.data;
                //TODO update page showing results?
            })
        }

        return votesObj;

    });


    </script>

</body>
</html>
